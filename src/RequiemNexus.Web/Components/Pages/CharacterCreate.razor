@page "/character/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using RequiemNexus.Data
@using RequiemNexus.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RequiemNexus.Web.Components.Pages.CharacterCreation
@using RequiemNexus.Web.Services
@using RequiemNexus.Web.Contracts
@inject ICharacterService CharacterService
@inject IClanService ClanService
@inject IMeritService MeritService
@inject IDisciplineService DisciplineService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Create Character - Requiem Nexus</PageTitle>

<div class="home-layout">
    <header class="main-header">
        <div class="header-content">
            <div class="brand">
                <h1><a href="/home" style="color: white; text-decoration: none;">REQUIEM NEXUS</a></h1>
            </div>
            
            <div class="header-actions">
                <span class="welcome-text">Create Character</span>
                <a href="/characters" class="nav-btn primary-btn" style="text-decoration: none;">Cancel</a>
            </div>
        </div>
    </header>

    <div class="dashboard-content" style="max-width: 800px; margin: 0 auto;">
        <div class="wizard-header" style="margin-bottom: 30px; border-bottom: 1px solid #330000; padding-bottom: 20px;">
            <h2>Embrace a New Kindred</h2>
            <div class="progress-bar" style="display: flex; gap: 10px; margin-top: 15px;">
                @for(int i = 1; i <= 5; i++)
                {
                    <div style="flex-grow: 1; height: 10px; background-color: @((int)currentStep >= i ? "#990000" : "#1a1a1a"); border-radius: 5px;"></div>
                }
            </div>
            <div class="step-text" style="color: #a0a0a0; margin-top: 10px; text-align: right;">
                Step @((int)currentStep) of 5
            </div>
        </div>

        <div class="wizard-body" style="background-color: #0f0f0f; border: 1px solid #330000; padding: 30px; border-radius: 8px;">
            @if (currentStep == CreationStep.BasicInformation)
            {
                <BasicInformationStep Character="newCharacter" 
                                      AvailableClans="availableClans" 
                                      OnStateChanged="StateHasChanged" />
            }
            else if (currentStep == CreationStep.Attributes)
            {
                <AttributesStep Character="newCharacter" 
                                MentalPointsSpent="MentalPointsSpent" 
                                PhysicalPointsSpent="PhysicalPointsSpent" 
                                SocialPointsSpent="SocialPointsSpent" 
                                TotalAttributePointsSpent="TotalAttributePointsSpent" 
                                IsValid="IsAttributeDistributionValid()" 
                                OnAdjustAttribute="AdjustAttribute" 
                                OnStateChanged="StateHasChanged" />
            }
            else if (currentStep == CreationStep.Skills)
            {
                <SkillsStep Character="newCharacter" 
                            MentalSkillsSpent="MentalSkillsSpent" 
                            PhysicalSkillsSpent="PhysicalSkillsSpent" 
                            SocialSkillsSpent="SocialSkillsSpent" 
                            TotalSkillPointsSpent="TotalSkillPointsSpent" 
                            IsValid="IsSkillDistributionValid()" 
                            OnAdjustSkill="AdjustSkill" 
                            OnStateChanged="StateHasChanged" />
            }
            else if (currentStep == CreationStep.MeritsAndDisciplines)
            {
                <MeritsAndDisciplinesStep Character="newCharacter" 
                                          AvailableMerits="availableMerits" 
                                          AvailableDisciplines="availableDisciplines" 
                                          MeritPointsSpent="MeritPointsSpent" 
                                          DisciplineDotsSpent="DisciplineDotsSpent" 
                                          IsValid="IsMeritDisciplineDistributionValid()" 
                                          OnAddMerit="HandleAddMerit" 
                                          OnAdjustMeritRating="AdjustMeritRating" 
                                          OnRemoveMerit="RemoveMerit" 
                                          OnAddDiscipline="HandleAddDiscipline" 
                                          OnAdjustDisciplineDots="AdjustDisciplineDots" 
                                          OnRemoveDiscipline="RemoveDiscipline" 
                                          OnStateChanged="StateHasChanged" />
            }
            else if (currentStep == CreationStep.ReviewAndEmbrace)
            {
                <ReviewAndEmbraceStep Character="newCharacter" 
                                      AvailableClans="availableClans" 
                                      MentalPointsSpent="MentalPointsSpent" 
                                      PhysicalPointsSpent="PhysicalPointsSpent" 
                                      SocialPointsSpent="SocialPointsSpent" 
                                      MentalSkillsSpent="MentalSkillsSpent" 
                                      PhysicalSkillsSpent="PhysicalSkillsSpent" 
                                      SocialSkillsSpent="SocialSkillsSpent" 
                                      MeritPointsSpent="MeritPointsSpent" 
                                      DisciplineDotsSpent="DisciplineDotsSpent" />
            }
        </div>

        <div class="wizard-footer" style="display: flex; justify-content: space-between; margin-top: 30px;">
            <button class="nav-btn primary-btn" style="background-color: #333;" @onclick="PreviousStep" disabled="@(currentStep == CreationStep.BasicInformation)">Back</button>
            
            @if (currentStep < CreationStep.ReviewAndEmbrace)
            {
                <button class="nav-btn primary-btn" @onclick="NextStep" disabled="@(!CanProceedToNextStep())">Next Step</button>
            }
            else
            {
                <button class="nav-btn primary-btn" style="background-color: #990000;" @onclick="SaveCharacter">Embrace</button>
            }
        </div>
    </div>
</div>

@code {
    public enum CreationStep
    {
        BasicInformation = 1,
        Attributes = 2,
        Skills = 3,
        MeritsAndDisciplines = 4,
        ReviewAndEmbrace = 5
    }

    private CreationStep currentStep = CreationStep.BasicInformation;
    private Character newCharacter = new Character();
    private List<Clan> availableClans = new List<Clan>();
    private string? currentUserId;

    private List<Merit> availableMerits = new List<Merit>();
    private List<Discipline> availableDisciplines = new List<Discipline>();

    private int MentalPointsSpent => (newCharacter.Intelligence - 1) + (newCharacter.Wits - 1) + (newCharacter.Resolve - 1);
    private int PhysicalPointsSpent => (newCharacter.Strength - 1) + (newCharacter.Dexterity - 1) + (newCharacter.Stamina - 1);
    private int SocialPointsSpent => (newCharacter.Presence - 1) + (newCharacter.Manipulation - 1) + (newCharacter.Composure - 1);
    private int TotalAttributePointsSpent => MentalPointsSpent + PhysicalPointsSpent + SocialPointsSpent;

    private int MentalSkillsSpent => newCharacter.Academics + newCharacter.Computer + newCharacter.Crafts + newCharacter.Investigation + newCharacter.Medicine + newCharacter.Occult + newCharacter.Politics + newCharacter.Science;
    private int PhysicalSkillsSpent => newCharacter.Athletics + newCharacter.Brawl + newCharacter.Drive + newCharacter.Firearms + newCharacter.Larceny + newCharacter.Stealth + newCharacter.Survival + newCharacter.Weaponry;
    private int SocialSkillsSpent => newCharacter.AnimalKen + newCharacter.Empathy + newCharacter.Expression + newCharacter.Intimidation + newCharacter.Persuasion + newCharacter.Socialize + newCharacter.Streetwise + newCharacter.Subterfuge;
    private int TotalSkillPointsSpent => MentalSkillsSpent + PhysicalSkillsSpent + SocialSkillsSpent;

    private int MeritPointsSpent => newCharacter.Merits.Sum(m => m.Rating);
    private int DisciplineDotsSpent => newCharacter.Disciplines.Sum(d => d.Rating);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        
        if (string.IsNullOrEmpty(currentUserId))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        newCharacter.ApplicationUserId = currentUserId;
        availableClans = await ClanService.GetAllClansAsync();
        availableMerits = await MeritService.GetAllMeritsAsync();
        availableDisciplines = await DisciplineService.GetAllDisciplinesAsync();
    }

    private void AdjustAttribute(string attributeName, int change)
    {
        var prop = typeof(Character).GetProperty(attributeName);
        if (prop != null)
        {
            int currentValue = (int)(prop.GetValue(newCharacter) ?? 0);
            int newValue = currentValue + change;
            if (newValue >= 1 && newValue <= 5)
            {
                prop.SetValue(newCharacter, newValue);
            }
        }
    }

    private void AdjustSkill(string skillName, int change)
    {
        var prop = typeof(Character).GetProperty(skillName);
        if (prop != null)
        {
            int currentValue = (int)(prop.GetValue(newCharacter) ?? 0);
            int newValue = currentValue + change;
            if (newValue >= 0 && newValue <= 5)
            {
                prop.SetValue(newCharacter, newValue);
            }
        }
    }

    private void HandleAddMerit(int meritId)
    {
        if (!newCharacter.Merits.Any(m => m.MeritId == meritId))
        {
            newCharacter.Merits.Add(new CharacterMerit { MeritId = meritId, Rating = 1, Specification = "N/A" });
        }
    }

    private void AdjustMeritRating(CharacterMerit cm, int change)
    {
        if (cm.Rating + change >= 1 && cm.Rating + change <= 5)
        {
            cm.Rating += change;
        }
    }

    private void RemoveMerit(CharacterMerit cm)
    {
        newCharacter.Merits.Remove(cm);
    }

    private void HandleAddDiscipline(int disciplineId)
    {
        if (!newCharacter.Disciplines.Any(d => d.DisciplineId == disciplineId))
        {
            newCharacter.Disciplines.Add(new CharacterDiscipline { DisciplineId = disciplineId, Rating = 1 });
        }
    }

    private void AdjustDisciplineDots(CharacterDiscipline cd, int change)
    {
        if (cd.Rating + change >= 1 && cd.Rating + change <= 5)
        {
            cd.Rating += change;
        }
    }

    private void RemoveDiscipline(CharacterDiscipline cd)
    {
        newCharacter.Disciplines.Remove(cd);
    }

    private void NextStep()
    {
        if (currentStep < CreationStep.ReviewAndEmbrace) currentStep++;
    }

    private void PreviousStep()
    {
        if (currentStep > CreationStep.BasicInformation) currentStep--;
    }

    private bool IsAttributeDistributionValid()
    {
        var points = new List<int> { MentalPointsSpent, PhysicalPointsSpent, SocialPointsSpent };
        points.Sort();
        // Strict 5/4/3 distribution means exactly those numbers when sorted.
        return points[0] == 3 && points[1] == 4 && points[2] == 5;
    }

    private bool IsSkillDistributionValid()
    {
        var points = new List<int> { MentalSkillsSpent, PhysicalSkillsSpent, SocialSkillsSpent };
        points.Sort();
        // Strict 11/7/4 distribution means exactly those numbers when sorted.
        return points[0] == 4 && points[1] == 7 && points[2] == 11;
    }

    private bool IsMeritDisciplineDistributionValid()
    {
        return MeritPointsSpent == 7 && DisciplineDotsSpent == 3;
    }

    private bool CanProceedToNextStep()
    {
        switch (currentStep)
        {
            case CreationStep.BasicInformation:
                return !string.IsNullOrWhiteSpace(newCharacter.Name) && newCharacter.ClanId.HasValue;
            case CreationStep.Attributes:
                return IsAttributeDistributionValid();
            case CreationStep.Skills:
                return IsSkillDistributionValid();
            case CreationStep.MeritsAndDisciplines:
                return IsMeritDisciplineDistributionValid();
            case CreationStep.ReviewAndEmbrace:
            default:
                return true;
        }
    }

    private async Task SaveCharacter()
    {
        try
        {
            await CharacterService.EmbraceCharacterAsync(newCharacter);
            NavigationManager.NavigateTo("/characters");
        }
        catch (Exception ex)
        {
            // Simple error handling for now
            Console.WriteLine($"Error saving character: {ex.Message}");
        }
    }
}
