@using RequiemNexus.Data.Models

<div class="step-content">
    <h3>Basic Information</h3>
    <p style="color: #a0a0a0; margin-bottom: 20px;">Who were you before the embrace? What bloodline flows through your veins?</p>

    <div class="form-group" style="margin-bottom: 20px;">
        <label for="name" style="display: block; margin-bottom: 8px; color: #e0e0e0;">Character Name</label>
        <input id="name" type="text" @bind="Character.Name" @bind:after="NotifyStateChanged" class="form-control" style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #330000; color: white; border-radius: 4px;" placeholder="Enter name..." />
    </div>

    <div class="form-group" style="margin-bottom: 20px;">
        <label for="clan" style="display: block; margin-bottom: 8px; color: #e0e0e0;">Clan</label>
        <select id="clan" @bind="Character.ClanId" @bind:after="NotifyStateChanged" class="form-control" style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #330000; color: white; border-radius: 4px;">
            <option value="">-- Select a Clan --</option>
            @foreach (var clan in AvailableClans)
            {
                <option value="@clan.Id">@clan.Name</option>
            }
        </select>
        @if (Character.ClanId.HasValue)
        {
            var selectedClan = AvailableClans.FirstOrDefault(c => c.Id == Character.ClanId);
            if (selectedClan != null)
            {
                <div style="margin-top: 10px; padding: 10px; background-color: #150000; border-left: 3px solid #990000; font-size: 0.9em; color: #d0d0d0;">
                    @selectedClan.Description
                </div>
            }
        }
    </div>
    <div class="form-group" style="margin-bottom: 20px;">
        <label for="mask" style="display: block; margin-bottom: 8px; color: #e0e0e0;">Mask</label>
        <input id="mask" type="text" @bind="Character.Mask" @bind:after="NotifyStateChanged" class="form-control" style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #330000; color: white; border-radius: 4px;" placeholder="The face you show the world..." />
    </div>

    <div class="form-group" style="margin-bottom: 20px;">
        <label for="dirge" style="display: block; margin-bottom: 8px; color: #e0e0e0;">Dirge</label>
        <input id="dirge" type="text" @bind="Character.Dirge" @bind:after="NotifyStateChanged" class="form-control" style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #330000; color: white; border-radius: 4px;" placeholder="Your true inner self..." />
    </div>

    <div class="form-group" style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: #e0e0e0;">Initial Aspirations</label>
        <p style="color: #a0a0a0; font-size: 0.85em; margin-bottom: 10px;">Define three goals your character wants to achieve (e.g., "Find a reliable haven", "Impress the Prince").</p>
        
        @if (Character.Aspirations != null)
        {
            var aspirationsList = Character.Aspirations.ToList();
            for (int i = 0; i < aspirationsList.Count; i++)
            {
                var index = i;
                <input type="text" @bind="aspirationsList[index].Description" @bind:after="NotifyStateChanged" class="form-control" style="width: 100%; padding: 10px; background-color: #1a1a1a; border: 1px solid #330000; color: white; border-radius: 4px; margin-bottom: 8px;" placeholder="Aspiration @(index + 1)..." />
            }
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public Character Character { get; set; } = default!;

    [Parameter, EditorRequired]
    public List<Clan> AvailableClans { get; set; } = default!;

    [Parameter]
    public EventCallback OnStateChanged { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Ensure we have exactly 3 initial aspirations to fill out during creation
        if (Character.Aspirations == null || !Character.Aspirations.Any())
        {
            Character.Aspirations ??= new List<CharacterAspiration>();
            while (Character.Aspirations.Count < 3)
            {
                Character.Aspirations.Add(new CharacterAspiration { CharacterId = Character.Id });
            }
        }
    }

    private async Task NotifyStateChanged()
    {
        if (OnStateChanged.HasDelegate)
        {
            await OnStateChanged.InvokeAsync();
        }
    }
}
