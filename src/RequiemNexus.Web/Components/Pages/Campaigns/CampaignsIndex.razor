@page "/campaigns"
@using Microsoft.EntityFrameworkCore
@using RequiemNexus.Data
@using RequiemNexus.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>My Campaigns - Requiem Nexus</PageTitle>

<div class="page-container fade-in">
    <div class="page-header-rn">
        <h2>My Campaigns</h2>
        <a href="/campaigns/create" class="btn-primary-rn btn-create">Create New Campaign</a>
    </div>

    @if (campaigns == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (!campaigns.Any())
    {
        <div class="empty-state-rn">
            <p>You haven't joined or created any campaigns yet.</p>
            <a href="/campaigns/create" class="btn-primary-rn btn-create btn-large">Create New Campaign</a>
        </div>
    }
    else
    {
        <div class="campaign-grid">
            @foreach (var campaign in campaigns)
            {
                <a href="/campaigns/@campaign.Id" class="campaign-card card-rn">
                    <h3>@campaign.Name</h3>
                    <p class="role-text">
                        @(IsStoryTeller(campaign) ? "üëë Story Teller" : "üó°Ô∏è Player")
                    </p>
                    <div class="card-stats-line">
                        <span>üë• Characters: @(campaign.Characters?.Count ?? 0)</span>
                    </div>
                </a>
            }
        </div>
    }
</div>

@code {
    private List<Campaign>? campaigns;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            campaigns = await DbContext.Campaigns
                .Include(c => c.Characters)
                .Include(c => c.StoryTeller)
                .Where(c => c.StoryTellerId == currentUserId || c.Characters.Any(ch => ch.ApplicationUserId == currentUserId))
                .AsNoTracking()
                .ToListAsync();
        }
        else
        {
            campaigns = new List<Campaign>();
        }
    }

    private bool IsStoryTeller(Campaign campaign)
    {
        return campaign.StoryTellerId == currentUserId;
    }
}
