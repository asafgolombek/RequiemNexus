@using RequiemNexus.Data.Models

<section class="cs-section cs-vitals">
    <h2>Vitals</h2>
    <div class="vitals-trackers">
        <div class="tracker-item">
            <span class="tracker-label">Health</span>
            <div class="tracker-boxes" style="cursor: pointer;">
                @for(int i = 0; i < Character.MaxHealth; i++)
                {
                    int captureIndex = i;
                    <div class="tracker-box health-box" @onclick="() => ToggleHealth(captureIndex)">
                        @GetHealthDamageChar(captureIndex)
                    </div>
                }
            </div>
        </div>
        <div class="tracker-item">
            <span class="tracker-label">Willpower</span>
            <div class="tracker-boxes" style="cursor: pointer;">
                @for(int i = 0; i < Character.MaxWillpower; i++)
                {
                    int captureIndex = i;
                    <div class="tracker-box @(i < Character.CurrentWillpower ? "filled" : "")" @onclick="() => ToggleWillpower(captureIndex)"></div>
                }
            </div>
        </div>
        <div class="tracker-item">
            <span class="tracker-label">Vitae</span>
            <div class="tracker-boxes" style="cursor: pointer;">
                @for(int i = 0; i < Character.MaxVitae; i++)
                {
                    int captureIndex = i;
                    <div class="tracker-box @(i < Character.CurrentVitae ? "filled dark" : "")" @onclick="() => ToggleVitae(captureIndex)"></div>
                }
            </div>
        </div>
    </div>
</section>

@code {
    [Parameter, EditorRequired]
    public Character Character { get; set; } = default!;

    [Parameter]
    public EventCallback OnChanged { get; set; }

    private string GetHealthDamageChar(int index)
    {
        if (string.IsNullOrEmpty(Character.HealthDamage) || index >= Character.HealthDamage.Length)
            return string.Empty;
        
        char damage = Character.HealthDamage[index];
        return damage == ' ' ? string.Empty : damage.ToString();
    }

    private async Task ToggleHealth(int index)
    {
        if (Character.HealthDamage == null) Character.HealthDamage = string.Empty;
        
        if (Character.HealthDamage.Length < Character.MaxHealth)
        {
            Character.HealthDamage = Character.HealthDamage.PadRight(Character.MaxHealth, ' ');
        }

        char currentDamage = Character.HealthDamage[index];
        char newDamage = currentDamage switch
        {
            ' ' => '/',
            '/' => 'X',
            'X' => '*',
            '*' => ' ',
            _ => '/'
        };

        var chars = Character.HealthDamage.ToCharArray();
        chars[index] = newDamage;
        Character.HealthDamage = new string(chars);

        // Keep CurrentHealth in sync with total damage boxes taken
        Character.CurrentHealth = Character.HealthDamage.Count(c => c != ' ');

        await NotifyChanged();
    }

    private async Task ToggleWillpower(int index)
    {
        if (index == Character.CurrentWillpower - 1) Character.CurrentWillpower--;
        else Character.CurrentWillpower = index + 1;
        await NotifyChanged();
    }

    private async Task ToggleVitae(int index)
    {
        if (index == Character.CurrentVitae - 1) Character.CurrentVitae--;
        else Character.CurrentVitae = index + 1;
        await NotifyChanged();
    }

    private async Task NotifyChanged()
    {
        if (OnChanged.HasDelegate)
        {
            await OnChanged.InvokeAsync();
        }
    }
}
