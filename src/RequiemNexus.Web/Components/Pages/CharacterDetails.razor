@page "/character/{Id:int}"
@rendermode InteractiveServer
@using RequiemNexus.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RequiemNexus.Web.Components.UI
@using RequiemNexus.Web.Components.Pages.CharacterSheet
@using RequiemNexus.Web.Contracts
@inject ICharacterService CharacterService
@inject IAdvancementService AdvancementService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(character?.Name ?? "Character Sheet") - Requiem Nexus</PageTitle>

@if (character == null)
{
    <p><em>Loading your immortal legacy...</em></p>
}
else
{
    <div class="character-sheet fade-in">
        <!-- HEADER -->
        <header class="cs-header">
            <div class="char-avatar"></div>
            <div class="char-info">
                @if (isEditingName)
                {
                    <input type="text" class="char-name-input" @bind="character.Name" @onblur="SaveNameOffBlur" @onkeyup="HandleNameKeyUp" autofocus />
                }
                else
                {
                    <h1 @onclick="() => isEditingName = true" style="cursor: pointer;" title="Click to edit name">@character.Name <i class="edit-icon">✎</i></h1>
                }
                <div class="char-meta">
                    <span><strong>Concept:</strong> @(string.IsNullOrEmpty(character.Concept) ? "???" : character.Concept)</span>
                    <span><strong>Clan:</strong> @(character.Clan?.Name ?? "None")</span>
                    <span><strong>Chronicle:</strong> @(character.Campaign?.Name ?? "None")</span>
                    <span><strong>Mask:</strong> @(string.IsNullOrEmpty(character.Mask) ? "???" : character.Mask)</span>
                    <span><strong>Dirge:</strong> @(string.IsNullOrEmpty(character.Dirge) ? "???" : character.Dirge)</span>
                    @if (isFreeEditMode)
                    {
                        <span><strong>Touchstone:</strong> <input type="text" @bind="character.Touchstone" class="char-meta-input" placeholder="e.g. My sibling" /></span>
                    }
                    else
                    {
                        <span><strong>Touchstone:</strong> @(string.IsNullOrEmpty(character.Touchstone) ? "???" : character.Touchstone)</span>
                    }
                </div>
                <div class="char-xp">
                    <div class="xp-counter">
                        <strong class="xp-counter-label">Beats</strong>
                        <button class="xp-counter-btn" @onclick="RemoveBeat"
                            disabled="@(character.Beats <= 0)">-</button>
                        <span class="xp-counter-value">@character.Beats</span>
                        <button class="xp-counter-btn" @onclick="AddBeat">+</button>
                    </div>
                    <div class="xp-counter">
                        <strong class="xp-counter-label">Experiences</strong>
                        <button class="xp-counter-btn" @onclick="RemoveXP"
                            disabled="@(character.ExperiencePoints <= 0)">-</button>
                        <span class="xp-counter-value">@character.ExperiencePoints</span>
                        <button class="xp-counter-btn" @onclick="AddXP">+</button>
                    </div>
                    <div class="xp-total">
                        <strong class="xp-counter-label">Total XP</strong>
                        <span class="xp-counter-value">@character.TotalExperiencePoints</span>
                    </div>

                    <button class="btn-ghost mode-toggle-btn"
                    @onclick="GoToAdvancement">
                        Enter Advancement
                    </button>
                    <button class="btn-ghost mode-toggle-btn @(isFreeEditMode ? "active" : "")"
                    @onclick="ToggleFreeEditMode">
                        @(isFreeEditMode ? "Finish Edit" : "Edit Character")
                    </button>
                </div>
            </div>
        </header>

        <div class="tab-bar">
            <button class="tab-btn @(activeTab == "sheet" ? "active" : "")" @onclick='() => activeTab = "sheet"'>Character
                Sheet</button>
            <button class="tab-btn @(activeTab == "identity" ? "active" : "")"
            @onclick='() => activeTab = "identity"'>Identity &amp; Backstory</button>
        </div>

        <CascadingValue Value="@(isAdvancementMode || isFreeEditMode)" Name="IsEditable">
            @if (activeTab == "sheet")
            {
                <div class="cs-grid">
                    <!-- VITALS / ADVANTAGES BARS (Top Grid Layer) -->
                    <CharacterVitals Character="character" OnChanged="SaveCharacter" />

                    <!-- ATTRIBUTES -->
                    <section class="cs-section cs-attributes">
                        <h2>Attributes</h2>
                        <div class="grid-3-col">
                            <div class="stat-col mental">
                                <h3>Mental</h3>
                                <DotScale @bind-Value="character.Intelligence" Label="Intelligence" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Wits" Label="Wits" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Resolve" Label="Resolve" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col physical">
                                <h3>Physical</h3>
                                <DotScale @bind-Value="character.Strength" Label="Strength" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Dexterity" Label="Dexterity" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Stamina" Label="Stamina" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col social">
                                <h3>Social</h3>
                                <DotScale @bind-Value="character.Presence" Label="Presence" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Manipulation" Label="Manipulation" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Composure" Label="Composure" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                        </div>
                    </section>

                    <!-- SKILLS -->
                    <section class="cs-section cs-skills">
                        <h2>Skills</h2>
                        <div class="grid-3-col">
                            <div class="stat-col mental">
                                <h3>Mental</h3>
                                <DotScale @bind-Value="character.Academics" Label="Academics" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Computer" Label="Computer" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Crafts" Label="Crafts" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Investigation" Label="Investigation"
                                    OnLabelClick="OpenReference" OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Medicine" Label="Medicine" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Occult" Label="Occult" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Politics" Label="Politics" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Science" Label="Science" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col physical">
                                <h3>Physical</h3>
                                <DotScale @bind-Value="character.Athletics" Label="Athletics" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Brawl" Label="Brawl" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Drive" Label="Drive" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Firearms" Label="Firearms" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Larceny" Label="Larceny" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Stealth" Label="Stealth" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Survival" Label="Survival" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Weaponry" Label="Weaponry" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col social">
                                <h3>Social</h3>
                                <DotScale @bind-Value="character.AnimalKen" Label="Animal Ken" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Empathy" Label="Empathy" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Expression" Label="Expression" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Intimidation" Label="Intimidation" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Persuasion" Label="Persuasion" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Socialize" Label="Socialize" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Streetwise" Label="Streetwise" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Subterfuge" Label="Subterfuge" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                        </div>
                    </section>

                    <!-- SUPERNATURAL & ADVANTAGES -->
                    <div class="grid-2-col">
                        <section class="cs-section cs-advantages">
                            <h2>Advantages</h2>
                            <DotScale @bind-Value="character.BloodPotency" Label="Blood Potency" Max="10"
                                OnLabelClick="OpenReference" OnRollClick="OpenRoller" />
                            <DotScale @bind-Value="character.Humanity" Label="Humanity" Max="10" OnLabelClick="OpenReference"
                                OnRollClick="OpenRoller" />

                            <h3 class="trait-subheading">Merits</h3>
                            <ul class="trait-list">
                                @foreach (var merit in character.Merits)
                                {
                                    <li class="trait-item">
                                        <span>@merit.Merit?.Name @(string.IsNullOrEmpty(merit.Specification) || merit.Specification == "N/A" ? "" :
                                $"({merit.Specification})")</span>
                                        <span class="trait-dots">@(new string('•',
                                merit.Rating))</span>
                                    </li>
                                }
                            </ul>
                        </section>
                        <section class="cs-section cs-disciplines">
                            <h2>Disciplines</h2>
                            <ul class="trait-list disciplines-list">
                                @foreach (var disc in character.Disciplines)
                                {
                                    <li class="trait-item discipline-item" style="flex-direction: column; align-items: stretch;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; cursor: pointer;" @onclick="() => ToggleDiscipline(disc.DisciplineId)">
                                            <span>
                                                @if (expandedDisciplines.Contains(disc.DisciplineId))
                                                {
                                                    <i class="oi oi-chevron-bottom" style="font-size: 0.8em; margin-right: 5px;"></i>
                                                }
                                                else
                                                {
                                                    <i class="oi oi-chevron-right" style="font-size: 0.8em; margin-right: 5px;"></i>
                                                }
                                                @disc.Discipline?.Name
                                            </span>
                                            <span class="trait-dots">@(new string('•', disc.Rating))</span>
                                        </div>
                                        
                                        @if (expandedDisciplines.Contains(disc.DisciplineId) && disc.Discipline?.Powers != null)
                                        {
                                            <div class="discipline-powers" style="margin-top: 10px; padding-left: 15px; border-left: 2px solid #550000; font-size: 0.9em; color: #d0d0d0;">
                                                @foreach (var power in disc.Discipline.Powers.Where(p => p.Level <= disc.Rating).OrderBy(p => p.Level))
                                                {
                                                    <div class="power-item" style="margin-bottom: 8px;">
                                                        <strong>Level @power.Level - @power.Name:</strong>
                                                        <p style="margin: 2px 0 0 0; font-size: 0.85em; color: #a0a0a0;">@power.Description</p>
                                                        @if (!string.IsNullOrEmpty(power.DicePool) || !string.IsNullOrEmpty(power.Cost))
                                                        {
                                                            <div style="font-size: 0.8em; color: #808080; margin-top: 2px;">
                                                                @(string.IsNullOrEmpty(power.DicePool) ? "" : $"Pool: {power.DicePool}")
                                                                @(string.IsNullOrEmpty(power.DicePool) || string.IsNullOrEmpty(power.Cost) ? "" : " | ")
                                                                @(string.IsNullOrEmpty(power.Cost) ? "" : $"Cost: {power.Cost}")
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </li>
                                }
                            </ul>
                        </section>
                    </div>

                    <!-- EQUIPMENT -->
                    <section class="cs-section cs-equipment">
                        <h2>Equipment</h2>

                        <div class="equipment-form">
                            <select @bind="selectedEquipmentId" class="equipment-select">
                                <option value="0">-- Select Equipment --</option>
                                @foreach (var eq in availableEquipment)
                                {
                                    <option value="@eq.Id">@eq.Name (@eq.Type.Trim())</option>
                                }
                            </select>
                            <input type="number" min="1" @bind="selectedEquipmentQuantity"
                                class="equipment-quantity" />
                            <button class="btn-primary-rn" @onclick="AddEquipment">Add</button>
                        </div>

                        <ul class="equipment-grid">
                            @foreach (var ce in character.CharacterEquipments)
                            {
                                <li class="equipment-item">
                                    <div class="equipment-info">
                                        <strong class="equipment-name">@ce.Equipment?.Name (x@ce.Quantity)</strong>
                                        <div class="equipment-meta">
                                            <span>Type: @ce.Equipment?.Type</span>
                                            @if (ce.Equipment?.Damage > 0)
                                            {
                                                <span>| Dmg: @ce.Equipment?.Damage</span>
                                            }
                                            @if (ce.Equipment?.ArmorRating > 0)
                                            {
                                                <span>| Arm: @ce.Equipment?.ArmorRating</span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(ce.Equipment?.Description))
                                        {
                                            <p class="equipment-desc">@ce.Equipment?.Description</p>
                                        }
                                    </div>
                                    <button class="equipment-remove-btn" @onclick="() => RemoveEquipment(ce.Id)">Remove</button>
                                </li>
                            }
                        </ul>
                    </section>

                </div>
            }
            else if (activeTab == "identity")
            {
        <CharacterIdentityTab Character="character" OnChanged="SaveCharacter" />
            }
    </CascadingValue>
    </div>

    <DiceRollerModal @bind-IsVisible="isRollerOpen" TraitName="@rollerTraitName" BaseDice="@rollerBaseDice" Character="character" />
}

@code {
    [Inject] NavigationManager NavigationManager { get; set; } = default!;

    [Parameter]
    public int Id { get; set; }

    private Character? character;
    private List<Equipment> availableEquipment = new List<Equipment>();
    private int selectedEquipmentId = 0;
    private int selectedEquipmentQuantity = 1;

    private bool isRollerOpen = false;
    private string rollerTraitName = string.Empty;
    private int rollerBaseDice = 1;

    private bool isAdvancementMode = false;
    private bool isFreeEditMode = false;
    private string activeTab = "sheet";
    private bool isEditingName = false;
    
    private HashSet<int> expandedDisciplines = new HashSet<int>();

    private void ToggleDiscipline(int disciplineId)
    {
        if (expandedDisciplines.Contains(disciplineId))
        {
            expandedDisciplines.Remove(disciplineId);
        }
        else
        {
            expandedDisciplines.Add(disciplineId);
        }
    }

    private void GoToAdvancement()
    {
        NavigationManager.NavigateTo($"/character/{Id}/advancement");
    }

    private async Task SaveNameOffBlur()
    {
        isEditingName = false;
        await SaveCharacter();
    }

    private async Task HandleNameKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveNameOffBlur();
        }
    }

    private void ToggleAdvancementMode()
    {
        isAdvancementMode = !isAdvancementMode;
        if (isAdvancementMode) isFreeEditMode = false;
    }

    private async Task ToggleFreeEditMode()
    {
        bool wasEditing = isFreeEditMode;
        isFreeEditMode = !isFreeEditMode;
        if (isFreeEditMode) isAdvancementMode = false;
        // Save when the user finishes editing (transitions from ON → OFF)
        if (!isFreeEditMode && wasEditing)
        {
            await SaveCharacter();
        }
    }

    private async Task SaveCharacter()
    {
        if (character != null)
        {
            await CharacterService.SaveAsync(character);
        }
    }

    private async Task HandleTraitChange(string traitName, int currentRating, int newRating)
    {
        if (character == null) return;

        if (isAdvancementMode)
        {
            if (newRating > currentRating)
            {
                bool success = AdvancementService.TryUpgradeCoreTrait(character, traitName, currentRating, newRating);
                if (success)
                {
                    await CharacterService.SaveAsync(character);
                }
            }
        }
        else if (isFreeEditMode)
        {
            AdvancementService.UpdateCoreTrait(character, traitName, newRating);
            if (traitName is "Stamina" or "Resolve" or "Composure")
                AdvancementService.RecalculateDerivedStats(character);
            await CharacterService.SaveAsync(character);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            character = await CharacterService.GetCharacterByIdAsync(Id, currentUserId);
            availableEquipment = await CharacterService.GetAvailableEquipmentAsync();
        }
    }

    private void OpenReference(string traitName)
    {
        Console.WriteLine($"Show Reference for: {traitName}");
    }

    private void OpenRoller(string traitName)
    {
        rollerTraitName = traitName;
        rollerBaseDice = GetTraitValue(traitName);
        isRollerOpen = true;
    }

    private int GetTraitValue(string traitName)
    {
        if (character == null) return 0;
        var prop = typeof(Character).GetProperty(traitName.Replace(" ", ""));
        return (int)(prop?.GetValue(character) ?? 0);
    }

    private async Task AddBeat()
    {
        if (character != null)
            await CharacterService.AddBeatAsync(character);
    }

    private async Task RemoveBeat()
    {
        if (character != null)
            await CharacterService.RemoveBeatAsync(character);
    }

    private async Task AddXP()
    {
        if (character != null)
            await CharacterService.AddXPAsync(character);
    }

    private async Task RemoveXP()
    {
        if (character != null)
            await CharacterService.RemoveXPAsync(character);
    }

    private async Task AddEquipment()
    {
        if (character != null && selectedEquipmentId > 0 && selectedEquipmentQuantity > 0)
        {
            var ce = await CharacterService.AddEquipmentAsync(character.Id, selectedEquipmentId, selectedEquipmentQuantity);
            ce.Equipment = availableEquipment.FirstOrDefault(e => e.Id == selectedEquipmentId);
            character.CharacterEquipments.Add(ce);

            selectedEquipmentId = 0;
            selectedEquipmentQuantity = 1;
        }
    }

    private async Task RemoveEquipment(int ceId)
    {
        if (character != null)
        {
            await CharacterService.RemoveEquipmentAsync(ceId);
            var ce = character.CharacterEquipments.FirstOrDefault(e => e.Id == ceId);
            if (ce != null) character.CharacterEquipments.Remove(ce);
        }
    }
}
