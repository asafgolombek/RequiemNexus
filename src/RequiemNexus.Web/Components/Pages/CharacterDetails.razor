@page "/character/{Id:int}"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using RequiemNexus.Data
@using RequiemNexus.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RequiemNexus.Web.Components.UI
@using RequiemNexus.Web.Components.Pages.CharacterSheet
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RequiemNexus.Web.Services.AdvancementService AdvancementService

<PageTitle>@(character?.Name ?? "Character Sheet") - Requiem Nexus</PageTitle>

@if (character == null)
{
    <p><em>Loading your immortal legacy...</em></p>
}
else
{
    <div class="character-sheet fade-in">
        <!-- HEADER -->
        <header class="cs-header">
            <div class="char-avatar"></div>
            <div class="char-info">
                <h1>@character.Name</h1>
                <div class="char-meta">
                    <span><strong>Concept:</strong> @(string.IsNullOrEmpty(character.Concept) ? "???" :
                    character.Concept)</span>
                    <span><strong>Clan:</strong> @(character.Clan?.Name ?? "None")</span>
                    <span><strong>Chronicle:</strong> @(character.Campaign?.Name ?? "None")</span>
                </div>
                <div class="char-xp">
                    <div class="xp-counter">
                        <strong class="xp-counter-label">Beats</strong>
                        <button class="xp-counter-btn" @onclick="RemoveBeat"
                            disabled="@(character.Beats <= 0)">-</button>
                        <span class="xp-counter-value">@character.Beats</span>
                        <button class="xp-counter-btn" @onclick="AddBeat">+</button>
                    </div>
                    <div class="xp-counter">
                        <strong class="xp-counter-label">Experiences</strong>
                        <button class="xp-counter-btn" @onclick="RemoveXP"
                            disabled="@(character.ExperiencePoints <= 0)">-</button>
                        <span class="xp-counter-value">@character.ExperiencePoints</span>
                        <button class="xp-counter-btn" @onclick="AddXP">+</button>
                    </div>
                    <div class="xp-total">
                        <strong class="xp-counter-label">Total XP</strong>
                        <span class="xp-counter-value">@character.TotalExperiencePoints</span>
                    </div>

                    <button class="btn-ghost mode-toggle-btn @(isAdvancementMode ? "active" : "")"
                    @onclick="ToggleAdvancementMode">
                        @(isAdvancementMode ? "Exit Advancement" : "Enter Advancement")
                    </button>
                    <button class="btn-ghost mode-toggle-btn @(isFreeEditMode ? "active" : "")"
                    @onclick="ToggleFreeEditMode">
                        @(isFreeEditMode ? "Exit Free Edit" : "Free Edit Mode")
                    </button>
                </div>
            </div>
        </header>

        <div class="tab-bar">
            <button class="tab-btn @(activeTab == "sheet" ? "active" : "")" @onclick='() => activeTab = "sheet"'>Character
                Sheet</button>
            <button class="tab-btn @(activeTab == "identity" ? "active" : "")"
            @onclick='() => activeTab = "identity"'>Identity & Backstory</button>
        </div>

        <CascadingValue Value="@(isAdvancementMode || isFreeEditMode)" Name="IsEditable">
            @if (activeTab == "sheet")
            {
                <div class="cs-grid">
                    <!-- VITALS / ADVANTAGES BARS (Top Grid Layer) -->
                    <CharacterVitals Character="character" OnChanged="SaveCharacter" />

                    <!-- ATTRIBUTES -->
                    <section class="cs-section cs-attributes">
                        <h2>Attributes</h2>
                        <div class="grid-3-col">
                            <div class="stat-col mental">
                                <h3>Mental</h3>
                                <DotScale @bind-Value="character.Intelligence" Label="Intelligence" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Wits" Label="Wits" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Resolve" Label="Resolve" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col physical">
                                <h3>Physical</h3>
                                <DotScale @bind-Value="character.Strength" Label="Strength" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Dexterity" Label="Dexterity" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Stamina" Label="Stamina" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col social">
                                <h3>Social</h3>
                                <DotScale @bind-Value="character.Presence" Label="Presence" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Manipulation" Label="Manipulation" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Composure" Label="Composure" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                        </div>
                    </section>

                    <!-- SKILLS -->
                    <section class="cs-section cs-skills">
                        <h2>Skills</h2>
                        <div class="grid-3-col">
                            <div class="stat-col mental">
                                <h3>Mental</h3>
                                <DotScale @bind-Value="character.Academics" Label="Academics" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Computer" Label="Computer" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Crafts" Label="Crafts" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Investigation" Label="Investigation"
                                    OnLabelClick="OpenReference" OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Medicine" Label="Medicine" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Occult" Label="Occult" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Politics" Label="Politics" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Science" Label="Science" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col physical">
                                <h3>Physical</h3>
                                <DotScale @bind-Value="character.Athletics" Label="Athletics" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Brawl" Label="Brawl" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Drive" Label="Drive" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Firearms" Label="Firearms" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Larceny" Label="Larceny" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Stealth" Label="Stealth" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Survival" Label="Survival" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Weaponry" Label="Weaponry" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                            <div class="stat-col social">
                                <h3>Social</h3>
                                <DotScale @bind-Value="character.AnimalKen" Label="Animal Ken" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Empathy" Label="Empathy" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Expression" Label="Expression" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Intimidation" Label="Intimidation" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Persuasion" Label="Persuasion" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Socialize" Label="Socialize" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Streetwise" Label="Streetwise" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                                <DotScale @bind-Value="character.Subterfuge" Label="Subterfuge" OnLabelClick="OpenReference"
                                    OnRollClick="OpenRoller" />
                            </div>
                        </div>
                    </section>

                    <!-- SUPERNATURAL & ADVANTAGES -->
                    <div class="grid-2-col">
                        <section class="cs-section cs-advantages">
                            <h2>Advantages</h2>
                            <DotScale @bind-Value="character.BloodPotency" Label="Blood Potency" Max="10"
                                OnLabelClick="OpenReference" OnRollClick="OpenRoller" />
                            <DotScale @bind-Value="character.Humanity" Label="Humanity" Max="10" OnLabelClick="OpenReference"
                                OnRollClick="OpenRoller" />

                            <h3 class="trait-subheading">Merits</h3>
                            <ul class="trait-list">
                                @foreach (var merit in character.Merits)
                                {
                                    <li class="trait-item">
                                        <span>@merit.Merit?.Name @(string.IsNullOrEmpty(merit.Specification) ? "" :
                                $"({merit.Specification})")</span>
                                        <span class="trait-dots">@(new string('•',
                                merit.Rating))</span>
                                    </li>
                                }
                            </ul>
                        </section>
                        <section class="cs-section cs-disciplines">
                            <h2>Disciplines</h2>
                            <ul class="trait-list">
                                @foreach (var disc in character.Disciplines)
                                {
                                    <li class="trait-item">
                                        <span>@disc.Discipline?.Name</span>
                                        <span class="trait-dots">@(new string('•',
                                disc.Rating))</span>
                                    </li>
                                }
                            </ul>
                        </section>
                    </div>

                    <!-- EQUIPMENT -->
                    <section class="cs-section cs-equipment">
                        <h2>Equipment</h2>

                        <div class="equipment-form">
                            <select @bind="selectedEquipmentId" class="equipment-select">
                                <option value="0">-- Select Equipment --</option>
                                @foreach (var eq in availableEquipment)
                                {
                                    <option value="@eq.Id">@eq.Name (@eq.Type.Trim())</option>
                                }
                            </select>
                            <input type="number" min="1" @bind="selectedEquipmentQuantity"
                                class="equipment-quantity" />
                            <button class="btn-primary-rn" @onclick="AddEquipment">Add</button>
                        </div>

                        <ul class="equipment-grid">
                            @foreach (var ce in character.CharacterEquipments)
                            {
                                <li class="equipment-item">
                                    <div class="equipment-info">
                                        <strong class="equipment-name">@ce.Equipment?.Name (x@ce.Quantity)</strong>
                                        <div class="equipment-meta">
                                            <span>Type: @ce.Equipment?.Type</span>
                                            @if (ce.Equipment?.Damage > 0)
                                            {
                                                <span>| Dmg: @ce.Equipment?.Damage</span>
                                            }
                                            @if (ce.Equipment?.ArmorRating > 0)
                                            {
                                                <span>| Arm: @ce.Equipment?.ArmorRating</span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(ce.Equipment?.Description))
                                        {
                                            <p class="equipment-desc">@ce.Equipment?.Description</p>
                                        }
                                    </div>
                                    <button class="equipment-remove-btn" @onclick="() => RemoveEquipment(ce.Id)">Del</button>
                                </li>
                            }
                        </ul>
                    </section>

                </div>
            }
            else if (activeTab == "identity")
            {
        <CharacterIdentityTab Character="character" OnChanged="SaveCharacter" />
            }
    </CascadingValue>
    </div>

    <DiceRollerModal @bind-IsVisible="isRollerOpen" TraitName="@rollerTraitName" BaseDice="@rollerBaseDice" />
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Character? character;
    private List<Equipment> availableEquipment = new List<Equipment>();
    private int selectedEquipmentId = 0;
    private int selectedEquipmentQuantity = 1;

    private bool isRollerOpen = false;
    private string rollerTraitName = string.Empty;
    private int rollerBaseDice = 1;

    private bool isAdvancementMode = false;
    private bool isFreeEditMode = false;
    private string activeTab = "sheet";

    private void ToggleAdvancementMode()
    {
        isAdvancementMode = !isAdvancementMode;
        if (isAdvancementMode) isFreeEditMode = false;
    }

    private void ToggleFreeEditMode()
    {
        isFreeEditMode = !isFreeEditMode;
        if (isFreeEditMode) isAdvancementMode = false;
    }

    private async Task SaveCharacter()
    {
        if (character != null)
        {
            await DbContext.SaveChangesAsync();
        }
    }

    private async Task HandleTraitChange(string traitName, int currentRating, int newRating)
    {
        if (character == null) return;

        if (isAdvancementMode)
        {
            if (newRating > currentRating)
            {
                bool success = AdvancementService.TryUpgradeCoreTrait(character, traitName, currentRating, newRating);
                if (success)
                {
                    await DbContext.SaveChangesAsync();
                }
            }
        }
        else if (isFreeEditMode)
        {
            AdvancementService.UpdateCoreTrait(character, traitName, newRating);
            await DbContext.SaveChangesAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            character = await DbContext.Characters
            .Include(c => c.Clan)
            .Include(c => c.Campaign)
            .Include(c => c.Merits).ThenInclude(m => m.Merit)
            .Include(c => c.Disciplines).ThenInclude(d => d.Discipline)
            .Include(c => c.CharacterEquipments).ThenInclude(ce => ce.Equipment)
            .FirstOrDefaultAsync(c => c.Id == Id && c.ApplicationUserId == currentUserId);

            availableEquipment = await DbContext.Equipment.OrderBy(e => e.Name).ToListAsync();
        }
    }

    private void OpenReference(string traitName)
    {
        Console.WriteLine($"Show Reference for: {traitName}");
    }

    private void OpenRoller(string traitName)
    {
        rollerTraitName = traitName;
        rollerBaseDice = GetTraitValue(traitName);
        isRollerOpen = true;
    }

    private int GetTraitValue(string traitName)
    {
        if (character == null) return 0;
        return traitName switch
        {
            "Intelligence" => character.Intelligence,
            "Wits" => character.Wits,
            "Resolve" => character.Resolve,
            "Strength" => character.Strength,
            "Dexterity" => character.Dexterity,
            "Stamina" => character.Stamina,
            "Presence" => character.Presence,
            "Manipulation" => character.Manipulation,
            "Composure" => character.Composure,
            "Academics" => character.Academics,
            "Computer" => character.Computer,
            "Crafts" => character.Crafts,
            "Investigation" => character.Investigation,
            "Medicine" => character.Medicine,
            "Occult" => character.Occult,
            "Politics" => character.Politics,
            "Science" => character.Science,
            "Athletics" => character.Athletics,
            "Brawl" => character.Brawl,
            "Drive" => character.Drive,
            "Firearms" => character.Firearms,
            "Larceny" => character.Larceny,
            "Stealth" => character.Stealth,
            "Survival" => character.Survival,
            "Weaponry" => character.Weaponry,
            "Animal Ken" => character.AnimalKen,
            "Empathy" => character.Empathy,
            "Expression" => character.Expression,
            "Intimidation" => character.Intimidation,
            "Persuasion" => character.Persuasion,
            "Socialize" => character.Socialize,
            "Streetwise" => character.Streetwise,
            "Subterfuge" => character.Subterfuge,
            "Blood Potency" => character.BloodPotency,
            "Humanity" => character.Humanity,
            _ => 0
        };
    }

    private async Task AddBeat()
    {
        if (character != null)
        {
            character.Beats++;
            if (character.Beats >= 5)
            {
                character.Beats -= 5;
                character.ExperiencePoints++;
                character.TotalExperiencePoints++;
            }
            await DbContext.SaveChangesAsync();
        }
    }

    private async Task RemoveBeat()
    {
        if (character != null && character.Beats > 0)
        {
            character.Beats--;
            await DbContext.SaveChangesAsync();
        }
    }

    private async Task AddXP()
    {
        if (character != null)
        {
            character.ExperiencePoints++;
            character.TotalExperiencePoints++;
            await DbContext.SaveChangesAsync();
        }
    }

    private async Task RemoveXP()
    {
        if (character != null && character.ExperiencePoints > 0)
        {
            character.ExperiencePoints--;
            character.TotalExperiencePoints--;
            await DbContext.SaveChangesAsync();
        }
    }

    private async Task AddEquipment()
    {
        if (character != null && selectedEquipmentId > 0 && selectedEquipmentQuantity > 0)
        {
            var ce = new CharacterEquipment
                {
                    CharacterId = character.Id,
                    EquipmentId = selectedEquipmentId,
                    Quantity = selectedEquipmentQuantity
                };
            DbContext.CharacterEquipments.Add(ce);
            await DbContext.SaveChangesAsync();

            ce.Equipment = availableEquipment.FirstOrDefault(e => e.Id == selectedEquipmentId);
            character.CharacterEquipments.Add(ce);

            selectedEquipmentId = 0;
            selectedEquipmentQuantity = 1;
        }
    }

    private async Task RemoveEquipment(int ceId)
    {
        if (character != null)
        {
            var ce = character.CharacterEquipments.FirstOrDefault(e => e.Id == ceId);
            if (ce != null)
            {
                DbContext.CharacterEquipments.Remove(ce);
                await DbContext.SaveChangesAsync();
                character.CharacterEquipments.Remove(ce);
            }
        }
    }
}
