@page "/characters"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using RequiemNexus.Data
@using RequiemNexus.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RequiemNexus.Web.Services
@using RequiemNexus.Web.Contracts
@inject ICharacterService CharacterService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>My Characters - Requiem Nexus</PageTitle>

<div class="page-container fade-in">
    <div class="page-header-rn">
        <h2>My Characters</h2>
        <a href="/character/create" class="btn-primary-rn btn-create">Create New Character</a>
    </div>

    @if (characters == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (!characters.Any())
    {
        <div class="empty-state-rn">
            <p>You haven't embraced any characters yet.</p>
            <a href="/character/create" class="btn-primary-rn btn-create btn-large">Create New Character</a>
        </div>
    }
    else
    {
        <div class="character-grid">
            @foreach (var character in characters)
            {
                <div class="character-card card-rn">
                    <div class="card-top">
                        <div class="char-avatar">
                            <span>@(character.Name?.Length > 0 ? character.Name[0].ToString().ToUpper() : "?")</span>
                        </div>
                        <div class="card-name-block">
                            <h3>@character.Name</h3>
                            <p class="clan-name">@(character.Clan?.Name ?? "Caitiff")</p>
                        </div>
                    </div>
                    <div class="vitals-bars">
                        <div class="vital-bar">
                            <span class="vital-label">Health</span>
                            <div class="bar-track">
                                <div class="bar-fill health-fill" style="width: @(character.MaxHealth > 0 ? (int)(100.0 * character.CurrentHealth / character.MaxHealth) : 0)%"></div>
                            </div>
                            <span class="vital-value">@character.CurrentHealth/@character.MaxHealth</span>
                        </div>
                        <div class="vital-bar">
                            <span class="vital-label">Willpower</span>
                            <div class="bar-track">
                                <div class="bar-fill wp-fill" style="width: @(character.MaxWillpower > 0 ? (int)(100.0 * character.CurrentWillpower / character.MaxWillpower) : 0)%"></div>
                            </div>
                            <span class="vital-value">@character.CurrentWillpower/@character.MaxWillpower</span>
                        </div>
                        <div class="vital-bar">
                            <span class="vital-label">Vitae</span>
                            <div class="bar-track">
                                <div class="bar-fill vitae-fill" style="width: @(character.MaxVitae > 0 ? (int)(100.0 * character.CurrentVitae / character.MaxVitae) : 0)%"></div>
                            </div>
                            <span class="vital-value">@character.CurrentVitae/@character.MaxVitae</span>
                        </div>
                    </div>
                    <div class="card-stats">
                        <span>ðŸ©¸ Blood Potency: @character.BloodPotency</span>
                    </div>
                    <div class="card-actions">
                        <a href="/character/@character.Id" class="btn-primary-rn">View Sheet</a>
                        <button @onclick="() => DeleteCharacter(character)" class="btn-danger-rn">Delete</button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Character>? characters;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            characters = await CharacterService.GetCharactersByUserIdAsync(currentUserId);
        }
        else
        {
            characters = new List<Character>();
        }
    }

    private async Task DeleteCharacter(Character character)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {character.Name}?");
        if (confirmed)
        {
            await CharacterService.DeleteCharacterAsync(character.Id);
            characters?.Remove(character);
        }
    }
}
