@page "/characters"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using RequiemNexus.Data
@using RequiemNexus.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RequiemNexus.Web.Services
@using RequiemNexus.Web.Contracts
@inject ICharacterService CharacterService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>My Characters - Requiem Nexus</PageTitle>

<div class="home-layout">
    <!-- Reusing Header for consistency -->
    <header class="main-header">
        <div class="header-content">
            <div class="brand">
                <h1><a href="/home" style="color: white; text-decoration: none;">REQUIEM NEXUS</a></h1>
            </div>
            
            <div class="header-actions">
                <span class="welcome-text">Welcome back</span>
                <button class="nav-btn primary-btn">Log Out</button>
            </div>
        </div>
    </header>

    <div class="dashboard-content">
        <div class="characters-header">
            <h2>My Characters</h2>
            <a href="/character/create" class="btn-create">Create New Character</a>
        </div>

        @if (characters == null)
        {
            <p><em>Loading...</em></p>
        }
        else if (!characters.Any())
        {
            <div class="empty-state">
                <p>You haven't embraced any characters yet.</p>
                <a href="/character/create" class="btn-create btn-large">Create New Character</a>
            </div>
        }
        else
        {
            <div class="character-grid">
                @foreach (var character in characters)
                {
                    <div class="character-card">
                        <h3>@character.Name</h3>
                        <p class="clan-name">@(character.Clan?.Name ?? "Caitiff")</p>
                        <div class="stats">
                            <span>‚ù§Ô∏è HP: @character.CurrentHealth / @character.MaxHealth</span>
                            <span>üõ°Ô∏è WP: @character.CurrentWillpower / @character.MaxWillpower</span>
                            <span>ü©∏ BP: @character.BloodPotency</span>
                            <span>üç∑ Vitae: @character.CurrentVitae / @character.MaxVitae</span>
                        </div>
                        <div class="attributes-preview" style="margin-top: 10px; font-size: 0.85rem; color: #a0a0a0;">
                            <strong>Attributes:</strong><br/>
                            Mental: @(character.Intelligence + character.Wits + character.Resolve) <br/>
                            Physical: @(character.Strength + character.Dexterity + character.Stamina) <br/>
                            Social: @(character.Presence + character.Manipulation + character.Composure)
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <a href="/character/@character.Id" class="primary-btn" style="text-decoration: none;">View Sheet</a>
                            <button @onclick="() => DeleteCharacter(character)" class="nav-btn" style="border-color: #ff4444; color: #ff4444;">Delete</button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<Character>? characters;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            characters = await CharacterService.GetCharactersByUserIdAsync(currentUserId);
        }
        else
        {
            // Not authenticated or user ID not found
            characters = new List<Character>();
        }
    }

    private async Task DeleteCharacter(Character character)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {character.Name}?");
        if (confirmed)
        {
            await CharacterService.DeleteCharacterAsync(character.Id);
            characters?.Remove(character);
        }
    }
}
